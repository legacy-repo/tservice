<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>tservice.db.core documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Tservice</span> <span class="project-version">0.5.4</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>tservice</span></div></div></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>api</span></div></div></li><li class="depth-3 branch"><a href="tservice.api.config.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>config</span></div></a></li><li class="depth-3"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>data</span></div></div></li><li class="depth-4"><a href="tservice.api.data.csv.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>csv</span></div></a></li><li class="depth-3 branch"><a href="tservice.api.plugin.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>plugin</span></div></a></li><li class="depth-3"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>schema</span></div></div></li><li class="depth-4"><a href="tservice.api.schema.task.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>task</span></div></a></li><li class="depth-3"><a href="tservice.api.storage.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>storage</span></div></a></li><li class="depth-4"><a href="tservice.api.storage.fs.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>fs</span></div></a></li><li class="depth-3 branch"><a href="tservice.api.task.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>task</span></div></a></li><li class="depth-3"><a href="tservice.api.util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-2 branch"><a href="tservice.config.html"><div class="inner"><span class="tree" style="top: -331px;"><span class="top" style="height: 340px;"></span><span class="bottom"></span></span><span>config</span></div></a></li><li class="depth-2 branch"><a href="tservice.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>db</span></div></div></li><li class="depth-3 branch current"><a href="tservice.db.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-3 branch"><a href="tservice.db.handler.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>handler</span></div></a></li><li class="depth-3"><a href="tservice.db.sql-helper.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>sql-helper</span></div></a></li><li class="depth-2 branch"><a href="tservice.dev-middleware.html"><div class="inner"><span class="tree" style="top: -114px;"><span class="top" style="height: 123px;"></span><span class="bottom"></span></span><span>dev-middleware</span></div></a></li><li class="depth-2 branch"><a href="tservice.env.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>env</span></div></a></li><li class="depth-2 branch"><a href="tservice.events.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>events</span></div></a></li><li class="depth-2 branch"><a href="tservice.handler.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>handler</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>lib</span></div></div></li><li class="depth-3 branch"><a href="tservice.lib.files.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>files</span></div></a></li><li class="depth-3"><a href="tservice.lib.fs.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>fs</span></div></a></li><li class="depth-2"><a href="tservice.middleware.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>middleware</span></div></a></li><li class="depth-3 branch"><a href="tservice.middleware.exception.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>exception</span></div></a></li><li class="depth-3"><a href="tservice.middleware.formats.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>formats</span></div></a></li><li class="depth-2 branch"><a href="tservice.nrepl.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>nrepl</span></div></a></li><li class="depth-2 branch"><a href="tservice.plugin.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>plugin</span></div></a></li><li class="depth-2 branch"><a href="tservice.plugin-jars.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>plugin-jars</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>plugins</span></div></div></li><li class="depth-3 branch"><a href="tservice.plugins.classloader.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>classloader</span></div></a></li><li class="depth-3 branch"><a href="tservice.plugins.dependencies.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>dependencies</span></div></a></li><li class="depth-3 branch"><a href="tservice.plugins.init-steps.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>init-steps</span></div></a></li><li class="depth-3 branch"><a href="tservice.plugins.initialize.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>initialize</span></div></a></li><li class="depth-3"><a href="tservice.plugins.plugin-proxy.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>plugin-proxy</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -176px;"><span class="top" style="height: 185px;"></span><span class="bottom"></span></span><span>routes</span></div></div></li><li class="depth-3 branch"><a href="tservice.routes.services.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>services</span></div></a></li><li class="depth-3 branch"><a href="tservice.routes.specs.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>specs</span></div></a></li><li class="depth-3"><a href="tservice.routes.task.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>task</span></div></a></li><li class="depth-2 branch"><a href="tservice.setup.html"><div class="inner"><span class="tree" style="top: -114px;"><span class="top" style="height: 123px;"></span><span class="bottom"></span></span><span>setup</span></div></a></li><li class="depth-2"><a href="tservice.task.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>task</span></div></a></li><li class="depth-3"><a href="tservice.task.sync-tasks.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>sync-tasks</span></div></a></li><li class="depth-2 branch"><a href="tservice.util.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>vendor</span></div></div></li><li class="depth-3"><a href="tservice.vendor.multiqc.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>multiqc</span></div></a></li><li class="depth-1"><a href="user.html"><div class="inner"><span class="tree" style="top: -1447px;"><span class="top" style="height: 1456px;"></span><span class="bottom"></span></span><span>user</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="tservice.db.core.html#var-*db*"><div class="inner"><span>*db*</span></div></a></li><li class="depth-1"><a href="tservice.db.core.html#var-clj-.3Ejsonb-pgobj"><div class="inner"><span>clj-&gt;jsonb-pgobj</span></div></a></li><li class="depth-1"><a href="tservice.db.core.html#var-connect-entity-tag.21"><div class="inner"><span>connect-entity-tag!</span></div></a></li><li class="depth-1"><a href="tservice.db.core.html#var-count-tasks"><div class="inner"><span>count-tasks</span></div></a></li><li class="depth-1"><a href="tservice.db.core.html#var-create-tag.21"><div class="inner"><span>create-tag!</span></div></a></li><li class="depth-1"><a href="tservice.db.core.html#var-create-task.21"><div class="inner"><span>create-task!</span></div></a></li><li class="depth-1"><a href="tservice.db.core.html#var-delete-all-tasks.21"><div class="inner"><span>delete-all-tasks!</span></div></a></li><li class="depth-1"><a href="tservice.db.core.html#var-delete-tag.21"><div class="inner"><span>delete-tag!</span></div></a></li><li class="depth-1"><a href="tservice.db.core.html#var-delete-task.21"><div class="inner"><span>delete-task!</span></div></a></li><li class="depth-1"><a href="tservice.db.core.html#var-get-tag-count"><div class="inner"><span>get-tag-count</span></div></a></li><li class="depth-1"><a href="tservice.db.core.html#var-pgobj-.3Eclj"><div class="inner"><span>pgobj-&gt;clj</span></div></a></li><li class="depth-1"><a href="tservice.db.core.html#var-search-tags"><div class="inner"><span>search-tags</span></div></a></li><li class="depth-1"><a href="tservice.db.core.html#var-search-tasks"><div class="inner"><span>search-tasks</span></div></a></li><li class="depth-1"><a href="tservice.db.core.html#var-search-tasks-with-tags"><div class="inner"><span>search-tasks-with-tags</span></div></a></li><li class="depth-1"><a href="tservice.db.core.html#var-update-task.21"><div class="inner"><span>update-task!</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">tservice.db.core</h1><div class="doc"><pre class="plaintext"></pre></div><div class="public anchor" id="var-*db*"><h3>*db*</h3><h4 class="dynamic">dynamic</h4><div class="usage"></div><div class="doc"><pre class="plaintext"></pre></div><div class="src-link"><a href="https://github.com/clinico-omics/tservice/blob/v0.5.4/src/tservice/db/core.clj#L13">view source</a></div></div><div class="public anchor" id="var-clj-.3Ejsonb-pgobj"><h3>clj-&gt;jsonb-pgobj</h3><div class="usage"><code>(clj-&gt;jsonb-pgobj value)</code></div><div class="doc"><pre class="plaintext"></pre></div><div class="src-link"><a href="https://github.com/clinico-omics/tservice/blob/v0.5.4/src/tservice/db/core.clj#L61">view source</a></div></div><div class="public anchor" id="var-connect-entity-tag.21"><h3>connect-entity-tag!</h3><div class="usage"><code>(connect-entity-tag! db)</code><code>(connect-entity-tag! db params)</code><code>(connect-entity-tag! db params options &amp; command-options)</code></div><div class="doc"><pre class="plaintext">Args: 
  {:tag_id 1 :entity_id "XXX" :category "choppy-app"}
  {:entity_id "XXX" :category "choppy-app" :tag_title "XXX"}
Description:
  Connect an app record with several tag records and then return the number of affected rows.
Examples: 
  Clojure: (connect-entity-tag! {:tag_id 1 :entity_id "test" :category "choppy-app"})</pre></div></div><div class="public anchor" id="var-count-tasks"><h3>count-tasks</h3><div class="usage"><code>(count-tasks db)</code><code>(count-tasks db params)</code><code>(count-tasks db params options &amp; command-options)</code></div><div class="doc"><pre class="plaintext">Args:
  {:query-map {:status "XXX"}}
Description:
  Count the queried tasks.
Examples:
  Clojure: (count-tasks)
  SQL: SELECT COUNT(id) FROM tservice_task

  Clojure: (count-tasks {:query-map {:status "XXX"}})
  HugSQL: SELECT COUNT(id) FROM tservice_task WHERE status = :v:query-map.status
  SQL: SELECT COUNT(id) FROM tservice_task WHERE status = "XXX"
TODO: 
  Maybe we need to support OR/LIKE/IS NOT/etc. expressions in WHERE clause.
FAQs:
  1. why we need to use :one as the :result
    Because the result will be ({:count 0}), when we use :raw to replace :one.</pre></div></div><div class="public anchor" id="var-create-tag.21"><h3>create-tag!</h3><div class="usage"><code>(create-tag! db)</code><code>(create-tag! db params)</code><code>(create-tag! db params options &amp; command-options)</code></div><div class="doc"><pre class="plaintext">Description:
  Create a new tag record and then return the number of affected rows.
Examples: 
  Clojure: (create-tag! {:title "title"})
Conditions:
  1. `ON CONFLICT` expression is only support by PostgreSQL
  2. `title` must have an unique or exclusion constrait</pre></div></div><div class="public anchor" id="var-create-task.21"><h3>create-task!</h3><div class="usage"><code>(create-task! db)</code><code>(create-task! db params)</code><code>(create-task! db params options &amp; command-options)</code></div><div class="doc"><pre class="plaintext">Args:
  | key                | type    | required  | description |
  |--------------------|---------|-----------|-------------|
  | :id                | uuid    | true/uniq | UUID string
  | :name              | string  | true      | The task name, required, [a-zA-Z0-9]+.
  | :description       | string  | false     | A description of the task.
  | :payload           | json    | false     | The payload of the related task.
  | :plugin_name       | string  | true      | Which plugin for generating task.
  | :plugin_type       | string  | true      | ReportPlugin, StatPlugin, DataPlugin etc.
  | :plugin_version    | string  | true      | Which plugin version.
  | :response          | json    | false     | Result response, different plugin may have different response.
  | :started_time      | bigint  | true      | Started time
  | :finished_time     | bigint  | false     | Finished time
  | :status            | string  | true      | Started, Finished, Failed
  | :percentage        | int     | false     | The percentage of a task.
Description:
  Create a new task record and then return the number of affected rows.
Examples: 
  Clojure: (create-task! {})</pre></div></div><div class="public anchor" id="var-delete-all-tasks.21"><h3>delete-all-tasks!</h3><div class="usage"><code>(delete-all-tasks! db)</code><code>(delete-all-tasks! db params)</code><code>(delete-all-tasks! db params options &amp; command-options)</code></div><div class="doc"><pre class="plaintext">Description:
  Delete all task records.
Examples:
  Clojure: (delete-all-tasks!)
  SQL: TRUNCATE tservice_task;</pre></div></div><div class="public anchor" id="var-delete-tag.21"><h3>delete-tag!</h3><div class="usage"><code>(delete-tag! db)</code><code>(delete-tag! db params)</code><code>(delete-tag! db params options &amp; command-options)</code></div><div class="doc"><pre class="plaintext">Description:
  Delete a tag record given the title
Examples:
  Clojure: (delete-tag! {:title "XXX"})
  SQL: DELETE FROM tservice_tag WHERE title = "XXX"</pre></div></div><div class="public anchor" id="var-delete-task.21"><h3>delete-task!</h3><div class="usage"><code>(delete-task! db)</code><code>(delete-task! db params)</code><code>(delete-task! db params options &amp; command-options)</code></div><div class="doc"><pre class="plaintext">Args:
  {:id "XXX"}
Description:
  Delete a task record given the id
Examples:
  Clojure: (delete-task! {:id "XXX"})
  SQL: DELETE FROM tservice_task WHERE id = "XXX"</pre></div></div><div class="public anchor" id="var-get-tag-count"><h3>get-tag-count</h3><div class="usage"><code>(get-tag-count db)</code><code>(get-tag-count db params)</code><code>(get-tag-count db params options &amp; command-options)</code></div><div class="doc"><pre class="plaintext">Description:
  Get count.
Examples:
  Clojure: (get-tag-count)
  SQL: SELECT COUNT(id) FROM tag

  Clojure: (get-tag-count {:query-map {:title "XXX"}})
  HugSQL: SELECT COUNT(id) FROM tservice_tag WHERE title = :v:query-map.title
  SQL: SELECT COUNT(id) FROM tservice_tag WHERE title = "XXX"
TODO: 
  Maybe we need to support OR/LIKE/IS NOT/etc. expressions in WHERE clause.
FAQs:
  1. why we need to use :one as the :result
    Because the result will be ({:count 0}), when we use :raw to replace :one.</pre></div></div><div class="public anchor" id="var-pgobj-.3Eclj"><h3>pgobj-&gt;clj</h3><div class="usage"><code>(pgobj-&gt;clj pgobj)</code></div><div class="doc"><pre class="plaintext"></pre></div><div class="src-link"><a href="https://github.com/clinico-omics/tservice/blob/v0.5.4/src/tservice/db/core.clj#L25">view source</a></div></div><div class="public anchor" id="var-search-tags"><h3>search-tags</h3><div class="usage"><code>(search-tags db)</code><code>(search-tags db params)</code><code>(search-tags db params options &amp; command-options)</code></div><div class="doc"><pre class="plaintext">Description:
  Get tags by using query map
Examples: 
  Clojure: (search-tags {:query-map {:title "XXX"}})
  HugSQL: SELECT * FROM tservice_tag WHERE title = :v:query-map.title
  SQL: SELECT * FROM tservice_tag WHERE title = "XXX"
TODO:
  1. Maybe we need to support OR/LIKE/IS NOT/etc. expressions in WHERE clause.
  2. Maybe we need to use exact field name to replace *.</pre></div></div><div class="public anchor" id="var-search-tasks"><h3>search-tasks</h3><div class="usage"><code>(search-tasks db)</code><code>(search-tasks db params)</code><code>(search-tasks db params options &amp; command-options)</code></div><div class="doc"><pre class="plaintext">Args:
  {:query-map {:status "XXX"} :limit 1 :offset 0}
Description:
  Get tasks by using query-map or honeysql where-clause
Examples: 
  Clojure: (search-tasks {:query-map {:status "XXX"}})
  HugSQL: SELECT * FROM tservice_task WHERE status = :v:query-map.status
  SQL: SELECT * FROM tservice_task WHERE status = "XXX"
TODO:
  1. Maybe we need to support OR/LIKE/IS NOT/etc. expressions in WHERE clause.
  2. Maybe we need to use exact field name to replace *.</pre></div></div><div class="public anchor" id="var-search-tasks-with-tags"><h3>search-tasks-with-tags</h3><div class="usage"><code>(search-tasks-with-tags db)</code><code>(search-tasks-with-tags db params)</code><code>(search-tasks-with-tags db params options &amp; command-options)</code></div><div class="doc"><pre class="plaintext">Args:
  {:query-map {:status "XXX"} :limit 1 :offset 0}
Description:
  Get tasks with tags by using query map
Examples: 
  Clojure: (search-tasks-with-tags {:query-map {:status "XXX"}})
  HugSQL:
    SELECT  tservice_task.id,
            tservice_task.name,
            tservice_task.description,
            tservice_task.payload,
            tservice_task.plugin_name,
            tservice_task.plugin_version,
            tservice_task.plugin_type,
            tservice_task.response,
            tservice_task.started_time,
            tservice_task.finished_time,
            tservice_task.status,
            tservice_task.percentage
            array_agg( tservice_tag.id ) as tag_ids,
            array_agg( tservice_tag.title ) as tags
    FROM tservice_entity_tag
    JOIN tservice_task ON tservice_entity_tag.entity_id = tservice_task.id
    JOIN tservice_tag ON tservice_entity_tag.tag_id = tservice_tag.id
    WHERE tservice_task.status = :v:query-map.status
    GROUP BY tservice_task.id
TODO:
  1. Maybe we need to support OR/LIKE/IS NOT/etc. expressions in WHERE clause.
  2. Maybe we need to use exact field name to replace *.
  3. Maybe we need to add tservice_entity_tag.category = "task" condition.</pre></div></div><div class="public anchor" id="var-update-task.21"><h3>update-task!</h3><div class="usage"><code>(update-task! db)</code><code>(update-task! db params)</code><code>(update-task! db params options &amp; command-options)</code></div><div class="doc"><pre class="plaintext">Args:
  {:updates {:status "Started" :finished_time 10000 :percentage 0} :id "3"}
Description: 
  Update an existing task record.
Examples:
  Clojure: (update-task! {:updates {:finished_time "finished-time" :status "status" :percentage 100} :id "3"})
  HugSQL: UPDATE tservice_task SET finished_time = :v:query-map.finished-time, status = :v:query-map.status WHERE id = :id
  SQL: UPDATE tservice_task SET finished_time = "finished_time", status = "status" WHERE id = "3"
TODO:
  It will be raise exception when (:updates params) is nil.</pre></div></div></div></body></html>